describe('account', function () {
  let parse;

  beforeEach(() => {
    parse = require('./index');
  });

  test('Sycomore - no transactions', () => {
    const text = [
      `0130004    00071EUR2 00010139479  280323                                                  0000003445691I`,
      `0730004    00071EUR2 00010139479  290323                                                  0000003445691I`,
    ];

    expect(parse(text)).toEqual({
      amounts: {
        diff: 0,
        end: 344569.19,
        start: 344569.19,
        transactions: 0,
      },
      header: {
        record_code: '01',
        bank_code: '30004',
        desk_code: '00071',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '00010139479',
        prev_date: '2023-03-28',
        prev_amount: '344569.19',
        _1: '',
        _2: '',
        _3: '',
        _4: '',
        _5: '',
      },
      footer: {
        record_code: '07',
        bank_code: '30004',
        desk_code: '00071',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '00010139479',
        next_date: '2023-03-29',
        next_amount: '344569.19',
      },
      transactions: [],
      problems: null,
    });
  });

  test('Sycomore 2 - no transactions', () => {
    const text = [
      `0130004    00823EUR2 00010738652  280323                                                  0000000008653O`,
      `0730004    00823EUR2 00010738652  290323                                                  0000000008653O`,
    ];

    expect(parse(text)).toEqual({
      amounts: {
        diff: 0,
        end: -865.36,
        start: -865.36,
        transactions: 0,
      },
      header: {
        record_code: '01',
        bank_code: '30004',
        desk_code: '00823',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '00010738652',
        prev_date: '2023-03-28',
        prev_amount: '-865.36',
        _1: '',
        _2: '',
        _3: '',
        _4: '',
        _5: '',
      },
      footer: {
        record_code: '07',
        bank_code: '30004',
        desk_code: '00823',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '00010738652',
        next_date: '2023-03-29',
        next_amount: '-865.36',
      },
      transactions: [],
      problems: null,
    });
  });

  test('Somewhere unknown example - no transactions', () => {
    const text = [
      `0130056    00917EUR2 09170295947  060921                                                  0000000008474P`,
      `0730056    00917EUR2 09170295947  070921                                                  0000000008474P                `,
    ];

    expect(parse(text)).toEqual({
      amounts: {
        diff: 0,
        end: -847.47,
        start: -847.47,
        transactions: 0,
      },
      header: {
        record_code: '01',
        bank_code: '30056',
        desk_code: '00917',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '09170295947',
        prev_date: '2021-09-06',
        prev_amount: '-847.47',
        _1: '',
        _2: '',
        _3: '',
        _4: '',
        _5: '',
      },
      footer: {
        record_code: '07',
        bank_code: '30056',
        desk_code: '00917',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '09170295947',
        next_date: '2021-09-07',
        next_amount: '-847.47',
      },
      transactions: [],
      problems: null,
    });
  });

  test('Sycomore 3', () => {
    const text = [
      `0130004    00585EUR2 00010156142  280323                                                  0000006564827I`,
      `0430004056800585EUR2 0001015614218290323  290323DOMUSVI                          0000000  0000000359190{`,
      `0530004056800585EUR2 0001015614218290323     NPYDOMUSVI`,
      `0530004056800585EUR2 0001015614218290323     LCC/INV/3867 8.2.2023`,
      `0530004056800585EUR2 0001015614218290323     RCNNOTPROVIDED`,
      `0530004056800585EUR2 0001015614218290323     PDOFR FRANCE`,
      `0430004081800585EUR2 00010156142B2290323  290323PRLV SEPA/DGFIP IMPOT                   0 0000000560630}FR46ZZZ005002`,
      `0530004081800585EUR2 00010156142B2290323     NBEDGFIP IMPOT`,
      `0530004081800585EUR2 00010156142B2290323     IBEFR46ZZZ005002`,
      `0530004081800585EUR2 00010156142B2290323     RUMNN804148211DGFIP2019921505K41FN7QQ`,
      `0530004081800585EUR2 00010156142B2290323     RCN220750510700113748308`,
      `0530004081800585EUR2 00010156142B2290323     LCCTVA-032023-3310CA3`,
      `0730004    00585EUR2 00010156142  290323                                                  0000006363387I`,
    ];

    expect(parse(text)).toEqual({
      amounts: {
        diff: 20144,
        end: 636338.79,
        start: 656482.79,
        transactions: 20144,
      },
      header: {
        record_code: '01',
        bank_code: '30004',
        _1: '',
        desk_code: '00585',
        currency_code: 'EUR',
        nb_of_dec: '2',
        _2: '',
        account_nb: '00010156142',
        _3: '',
        prev_date: '2023-03-28',
        _4: '',
        prev_amount: '656482.79',
        _5: '',
      },
      footer: {
        record_code: '07',
        bank_code: '30004',
        desk_code: '00585',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '00010156142',
        next_date: '2023-03-29',
        next_amount: '636338.79',
      },
      transactions: [
        {
          record_code: '04',
          bank_code: '30004',
          internal_code: '0568',
          desk_code: '00585',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: '',
          account_nb: '00010156142',
          operation_code: '18',
          operation_date: '2023-03-29',
          reject_code: '',
          value_date: '2023-03-29',
          label: 'DOMUSVI',
          _2: '',
          reference: '0000000',
          exempt_code: '',
          _3: '',
          amount: '35919',
          '_4:': '',
          debtor_name: 'DOMUSVI',
          remittance_information_1: '/INV/3867 8.2.2023',
          end2end_identification: 'NOTPROVIDED',
          purpose: '',
          PDO: 'FR FRANCE',
        },
        {
          record_code: '04',
          bank_code: '30004',
          internal_code: '0818',
          desk_code: '00585',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: '',
          account_nb: '00010156142',
          operation_code: 'B2',
          operation_date: '2023-03-29',
          reject_code: '',
          value_date: '2023-03-29',
          label: 'PRLV SEPA/DGFIP IMPOT',
          _2: '',
          reference: '',
          exempt_code: '0',
          _3: '',
          amount: '-56063',
          '_4:': 'FR46ZZZ005002',
          creditor_name: 'DGFIP IMPOT',
          creditor_id: 'FR46ZZZ005002',
          creditor_id_type: '',
          mandate_identification: 'NN804148211DGFIP2019921505K41FN7QQ',
          sequence_type: '',
          end2end_identification: '220750510700113748308',
          purpose: '',
          remittance_information_1: 'TVA-032023-3310CA3',
        },
      ],
      problems: [
        {
          message: 'Transaction #1 has problem(s)',
          line: '0730004    00585EUR2 00010156142  290323                                                  0000006363387I',
          details: ['transaction header missing part "reference"'],
        },
        {
          details: '"transactions[1].reference" is not allowed to be empty',
          message: 'Malformed account',
        },
      ],
    });
  });

  test('Known bank', () => {
    const text = [
      `0118020    00001EUR2 00410GXLT01  060423                                                  0000000012258N`,
      `0418020404100001EUR2 00410GXLT0121070423  050423VIREMENT BANCAIRE EN VOTRE FAVE  3175387 00000000594363K000070`,
      `0518020404100001EUR2 00410GXLT0121070423  050423URN 5335098    VIREMENT N 53350`,
      `0418020312600001EUR2 00410GXLT0167070423  050423TVA SUR PRECOMPTE DE COMM. DE F  3175387 00000000001429P000002`,
      `0518020312600001EUR2 00410GXLT0167070423  050423INANCEMENT   VIREMENT N 5335098`,
      `0418020302600001EUR2 00410GXLT0161070423  050423PRECOMPTE DE COMM. DE FINANCEME  3175387 00000000007148N000001`,
      `0518020302600001EUR2 00410GXLT0161070423  050423NT   VIREMENT N 5335098`,
      `0418020608100001EUR2 00410GXLT0191070423  070423PRELEVEMENT DE FG 10.00P SUR RE  3173891 00000000059253P000073`,
      `0518020608100001EUR2 00410GXLT0191070423  070423MISE N 2740649`,
      `0418020608300001EUR2 00410GXLT0191070423  070423PRELEVEMENT DE FONDS DE RESERVE  3173891 00000000023701N000017`,
      `0518020608300001EUR2 00410GXLT0191070423  070423 SUR REMISE N 2740649`,
      `0418020303100001EUR2 00410GXLT0167070423  070423TVA SUR COMMISSION D AFFACTURAG  3173891 00000000000273O000003`,
      `0518020303100001EUR2 00410GXLT0167070423  070423E SUR REMISE N 2740649`,
      `0418020302100001EUR2 00410GXLT0165070423  070423COMMISSION D AFFACTURAGE SUR RE  3173891 00000000001367R000002`,
      `0518020302100001EUR2 00410GXLT0165070423  070423MISE N 2740649`,
      `0418020100100001EUR2 00410GXLT0191070423  070423ACHAT REMISE DE FACTURES  REMIS  3173891 00000000911857G000001`,
      `0518020100100001EUR2 00410GXLT0191070423  070423E N 2740649`,
      `0418020312200001EUR2 00410GXLT0167070423  070423TVA SUR COMMISSION SUR REMISE D  3173163 00000000000063N000003`,
      `0518020312200001EUR2 00410GXLT0167070423  070423 AVOIRS   REMISE N 2740651`,
      `0418020302200001EUR2 00410GXLT0165070423  070423COMMISSION SUR REMISE D AVOIRS   3173163 00000000000317N000002`,
      `0518020302200001EUR2 00410GXLT0165070423  070423 REMISE N 2740651`,
      `0418020100200001EUR2 00410GXLT0191070423  070423ACHAT REMISE D AVOIRS  REMISE N  3173163 00000000211680J000001`,
      `0518020100200001EUR2 00410GXLT0191070423  070423 2740651`,
      `0718020    00001EUR2 00410GXLT01  070423                                                  0000000000000}`,
    ];

    expect(parse(text)).toEqual({
      amounts: {
        diff: 1225.85,
        end: 0,
        start: -1225.85,
        transactions: 1225.85,
      },
      header: {
        record_code: '01',
        bank_code: '18020',
        desk_code: '00001',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '00410GXLT01',
        prev_date: '2023-04-06',
        prev_amount: '-1225.85',
        _1: '',
        _2: '',
        _3: '',
        _4: '',
        _5: '',
      },
      footer: {
        record_code: '07',
        bank_code: '18020',
        desk_code: '00001',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '00410GXLT01',
        next_date: '2023-04-07',
        next_amount: '0',
      },
      transactions: [
        {
          423: 'URN 5335098    VIREMENT N 53350',
          _1: '',
          _2: '050',
          _3: '0',
          '_4:': '000070',
          account_nb: '00410GXLT01',
          amount: '-59436.32',
          bank_code: '18020',
          currency_code: 'EUR',
          desk_code: '00001',
          exempt_code: '',
          internal_code: '4041',
          label: 'VIREMENT BANCAIRE EN VOTRE FAVE',
          nb_of_dec: '2',
          operation_code: '21',
          operation_date: '2023-04-07',
          record_code: '04',
          reference: '3175387',
          reject_code: '',
          value_date: '2023-04-05',
        },
        {
          423: 'INANCEMENT   VIREMENT N 5335098',
          _1: '',
          _2: '050',
          _3: '0',
          '_4:': '000002',
          account_nb: '00410GXLT01',
          amount: '-142.97',
          bank_code: '18020',
          currency_code: 'EUR',
          desk_code: '00001',
          exempt_code: '',
          internal_code: '3126',
          label: 'TVA SUR PRECOMPTE DE COMM. DE F',
          nb_of_dec: '2',
          operation_code: '67',
          operation_date: '2023-04-07',
          record_code: '04',
          reference: '3175387',
          reject_code: '',
          value_date: '2023-04-05',
        },
        {
          423: 'NT   VIREMENT N 5335098',
          _1: '',
          _2: '050',
          _3: '0',
          '_4:': '000001',
          account_nb: '00410GXLT01',
          amount: '-714.85',
          bank_code: '18020',
          currency_code: 'EUR',
          desk_code: '00001',
          exempt_code: '',
          internal_code: '3026',
          label: 'PRECOMPTE DE COMM. DE FINANCEME',
          nb_of_dec: '2',
          operation_code: '61',
          operation_date: '2023-04-07',
          record_code: '04',
          reference: '3175387',
          reject_code: '',
          value_date: '2023-04-05',
        },
        {
          423: 'MISE N 2740649',
          _1: '',
          _2: '070',
          _3: '0',
          '_4:': '000073',
          account_nb: '00410GXLT01',
          amount: '-5925.37',
          bank_code: '18020',
          currency_code: 'EUR',
          desk_code: '00001',
          exempt_code: '',
          internal_code: '6081',
          label: 'PRELEVEMENT DE FG 10.00P SUR RE',
          nb_of_dec: '2',
          operation_code: '91',
          operation_date: '2023-04-07',
          record_code: '04',
          reference: '3173891',
          reject_code: '',
          value_date: '2023-04-07',
        },
        {
          423: 'SUR REMISE N 2740649',
          _1: '',
          _2: '070',
          _3: '0',
          '_4:': '000017',
          account_nb: '00410GXLT01',
          amount: '-2370.15',
          bank_code: '18020',
          currency_code: 'EUR',
          desk_code: '00001',
          exempt_code: '',
          internal_code: '6083',
          label: 'PRELEVEMENT DE FONDS DE RESERVE',
          nb_of_dec: '2',
          operation_code: '91',
          operation_date: '2023-04-07',
          record_code: '04',
          reference: '3173891',
          reject_code: '',
          value_date: '2023-04-07',
        },
        {
          423: 'E SUR REMISE N 2740649',
          _1: '',
          _2: '070',
          _3: '0',
          '_4:': '000003',
          account_nb: '00410GXLT01',
          amount: '-27.36',
          bank_code: '18020',
          currency_code: 'EUR',
          desk_code: '00001',
          exempt_code: '',
          internal_code: '3031',
          label: 'TVA SUR COMMISSION D AFFACTURAG',
          nb_of_dec: '2',
          operation_code: '67',
          operation_date: '2023-04-07',
          record_code: '04',
          reference: '3173891',
          reject_code: '',
          value_date: '2023-04-07',
        },
        {
          423: 'MISE N 2740649',
          _1: '',
          _2: '070',
          _3: '0',
          '_4:': '000002',
          account_nb: '00410GXLT01',
          amount: '-136.79',
          bank_code: '18020',
          currency_code: 'EUR',
          desk_code: '00001',
          exempt_code: '',
          internal_code: '3021',
          label: 'COMMISSION D AFFACTURAGE SUR RE',
          nb_of_dec: '2',
          operation_code: '65',
          operation_date: '2023-04-07',
          record_code: '04',
          reference: '3173891',
          reject_code: '',
          value_date: '2023-04-07',
        },
        {
          423: 'E N 2740649',
          _1: '',
          _2: '070',
          _3: '0',
          '_4:': '000001',
          account_nb: '00410GXLT01',
          amount: '91185.77',
          bank_code: '18020',
          currency_code: 'EUR',
          desk_code: '00001',
          exempt_code: '',
          internal_code: '1001',
          label: 'ACHAT REMISE DE FACTURES  REMIS',
          nb_of_dec: '2',
          operation_code: '91',
          operation_date: '2023-04-07',
          record_code: '04',
          reference: '3173891',
          reject_code: '',
          value_date: '2023-04-07',
        },
        {
          423: 'AVOIRS   REMISE N 2740651',
          _1: '',
          _2: '070',
          _3: '0',
          '_4:': '000003',
          account_nb: '00410GXLT01',
          amount: '-6.35',
          bank_code: '18020',
          currency_code: 'EUR',
          desk_code: '00001',
          exempt_code: '',
          internal_code: '3122',
          label: 'TVA SUR COMMISSION SUR REMISE D',
          nb_of_dec: '2',
          operation_code: '67',
          operation_date: '2023-04-07',
          record_code: '04',
          reference: '3173163',
          reject_code: '',
          value_date: '2023-04-07',
        },
        {
          423: 'REMISE N 2740651',
          _1: '',
          _2: '070',
          _3: '0',
          '_4:': '000002',
          account_nb: '00410GXLT01',
          amount: '-31.75',
          bank_code: '18020',
          currency_code: 'EUR',
          desk_code: '00001',
          exempt_code: '',
          internal_code: '3022',
          label: 'COMMISSION SUR REMISE D AVOIRS',
          nb_of_dec: '2',
          operation_code: '65',
          operation_date: '2023-04-07',
          record_code: '04',
          reference: '3173163',
          reject_code: '',
          value_date: '2023-04-07',
        },
        {
          423: '2740651',
          _1: '',
          _2: '070',
          _3: '0',
          '_4:': '000001',
          account_nb: '00410GXLT01',
          amount: '-21168.01',
          bank_code: '18020',
          currency_code: 'EUR',
          desk_code: '00001',
          exempt_code: '',
          internal_code: '1002',
          label: 'ACHAT REMISE D AVOIRS  REMISE N',
          nb_of_dec: '2',
          operation_code: '91',
          operation_date: '2023-04-07',
          record_code: '04',
          reference: '3173163',
          reject_code: '',
          value_date: '2023-04-07',
        },
      ],
      problems: [
        {
          details: '"transactions[0].423" is not allowed',
          message: 'Malformed account',
        },
      ],
    });
  });

  test('Known bank - with specific provider transactions', () => {
    const text = [
      '0118020    00001EUR2 00410GXLT11  050423                                                  0000024431270M                ',
      '0418020505100001EUR2 00410GXLT1105060423  310323VIREMENT RECU  FACTURE N 806500  3142953 00000000006000{000005          ',
      '0518020505100001EUR2 00410GXLT1105060423  31032341 LEROY MERLIN FRANCE                                                  ',
      '0418020505100001EUR2 00410GXLT1105060423  310323VIREMENT RECU  FACTURE N 806448  3142951 00000000012000{000005          ',
      '0518020505100001EUR2 00410GXLT1105060423  31032332 LEROY MERLIN FRANCE                                                  ',
      '0418020505100001EUR2 00410GXLT1105060423  310323VIREMENT RECU  FACTURE N 806471  3142949 00000000006000{000005          ',
      '0518020505100001EUR2 00410GXLT1105060423  31032340 LEROY MERLIN FRANCE                                                  ',
      '0418020505100001EUR2 00410GXLT1105060423  310323VIREMENT RECU  FACTURE N 806472  3142948 00000000006000{000005          ',
      '0518020505100001EUR2 00410GXLT1105060423  31032362 LEROY MERLIN FRANCE                                                  ',
      '0418020505100001EUR2 00410GXLT1105060423  310323VIREMENT RECU  FACTURE N 806473  3142947 00000000006000{000005          ',
      '0518020505100001EUR2 00410GXLT1105060423  31032301 LEROY MERLIN FRANCE                                                  ',
      '0718020    00001EUR2 00410GXLT11  060423                                                  0000024365270M                ',
    ];

    expect(parse(text)).toEqual({
      amounts: {
        diff: 6600,
        end: -2436527.04,
        start: -2443127.04,
        transactions: 3600,
      },
      header: {
        record_code: '01',
        bank_code: '18020',
        desk_code: '00001',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '00410GXLT11',
        prev_date: '2023-04-05',
        prev_amount: '-2443127.04',
        _1: '',
        _2: '',
        _3: '',
        _4: '',
        _5: '',
      },
      footer: {
        record_code: '07',
        bank_code: '18020',
        desk_code: '00001',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '00410GXLT11',
        next_date: '2023-04-06',
        next_amount: '-2436527.04',
      },
      problems: [
        {
          message:
            "Sum of transactions (3600) doesn't match with difference between start amount -2443127.04 and end amount -2436527.04",
        },
        {
          details: '"transactions[0].323" is not allowed',
          message: 'Malformed account',
        },
      ],
      transactions: [
        {
          323: '41 LEROY MERLIN FRANCE',
          record_code: '04',
          bank_code: '18020',
          internal_code: '5051',
          desk_code: '00001',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: '',
          account_nb: '00410GXLT11',
          operation_code: '05',
          operation_date: '2023-04-06',
          reject_code: '',
          value_date: '2023-03-31',
          label: 'VIREMENT RECU  FACTURE N 806500',
          _2: '310',
          reference: '3142953',
          exempt_code: '',
          _3: '0',
          amount: '600',
          '_4:': '000005',
        },
        {
          323: '32 LEROY MERLIN FRANCE',
          record_code: '04',
          bank_code: '18020',
          internal_code: '5051',
          desk_code: '00001',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: '',
          account_nb: '00410GXLT11',
          operation_code: '05',
          operation_date: '2023-04-06',
          reject_code: '',
          value_date: '2023-03-31',
          label: 'VIREMENT RECU  FACTURE N 806448',
          _2: '310',
          reference: '3142951',
          exempt_code: '',
          _3: '0',
          amount: '1200',
          '_4:': '000005',
        },
        {
          323: '40 LEROY MERLIN FRANCE',
          record_code: '04',
          bank_code: '18020',
          internal_code: '5051',
          desk_code: '00001',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: '',
          account_nb: '00410GXLT11',
          operation_code: '05',
          operation_date: '2023-04-06',
          reject_code: '',
          value_date: '2023-03-31',
          label: 'VIREMENT RECU  FACTURE N 806471',
          _2: '310',
          reference: '3142949',
          exempt_code: '',
          _3: '0',
          amount: '600',
          '_4:': '000005',
        },
        {
          323: '62 LEROY MERLIN FRANCE',
          record_code: '04',
          bank_code: '18020',
          internal_code: '5051',
          desk_code: '00001',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: '',
          account_nb: '00410GXLT11',
          operation_code: '05',
          operation_date: '2023-04-06',
          reject_code: '',
          value_date: '2023-03-31',
          label: 'VIREMENT RECU  FACTURE N 806472',
          _2: '310',
          reference: '3142948',
          exempt_code: '',
          _3: '0',
          amount: '600',
          '_4:': '000005',
        },
        {
          323: '01 LEROY MERLIN FRANCE',
          record_code: '04',
          bank_code: '18020',
          internal_code: '5051',
          desk_code: '00001',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: '',
          account_nb: '00410GXLT11',
          operation_code: '05',
          operation_date: '2023-04-06',
          reject_code: '',
          value_date: '2023-03-31',
          label: 'VIREMENT RECU  FACTURE N 806473',
          _2: '310',
          reference: '3142947',
          exempt_code: '',
          _3: '0',
          amount: '600',
          '_4:': '000005',
        },
      ],
    });
  });

  test('Known bank 2', () => {
    const text = [
      `0118020    00001EUR2 00410GXLT01  030323                                                  0000000773178H`,
      `0418020404100001EUR2 00410GXLT0121060323  040323VIREMENT BANCAIRE EN VOTRE FAVE  2059801 00000000771083K000070`,
      `0518020404100001EUR2 00410GXLT0121060323  040323URN 5295341    VIREMENT N 52953`,
      `0418020312600001EUR2 00410GXLT0167060323  040323TVA SUR PRECOMPTE DE COMM. DE F  2059801 00000000000349L000002`,
      `0518020312600001EUR2 00410GXLT0167060323  040323INANCEMENT   VIREMENT N 5295341`,
      `0418020302600001EUR2 00410GXLT0161060323  040323PRECOMPTE DE COMM. DE FINANCEME  2059801 00000000001746L000001`,
      `0518020302600001EUR2 00410GXLT0161060323  040323NT   VIREMENT N 5295341`,
      `0718020    00001EUR2 00410GXLT01  060323                                                  0000000000000}`,
    ];

    expect(parse(text)).toEqual({
      amounts: {
        diff: 77317.88,
        end: 0,
        start: 77317.88,
        transactions: 77317.88,
      },
      header: {
        record_code: '01',
        bank_code: '18020',
        desk_code: '00001',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '00410GXLT01',
        prev_date: '2023-03-03',
        prev_amount: '77317.88',
        _1: '',
        _2: '',
        _3: '',
        _4: '',
        _5: '',
      },
      footer: {
        record_code: '07',
        bank_code: '18020',
        desk_code: '00001',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '00410GXLT01',
        next_date: '2023-03-06',
        next_amount: '0',
      },
      transactions: [
        {
          323: 'URN 5295341    VIREMENT N 52953',
          _1: '',
          _2: '040',
          _3: '0',
          '_4:': '000070',
          record_code: '04',
          bank_code: '18020',
          desk_code: '00001',
          currency_code: 'EUR',
          nb_of_dec: '2',
          account_nb: '00410GXLT01',
          operation_code: '21',
          operation_date: '2023-03-06',
          reject_code: '',
          value_date: '2023-03-04',
          label: 'VIREMENT BANCAIRE EN VOTRE FAVE',
          reference: '2059801',
          exempt_code: '',
          amount: '-77108.32',
          internal_code: '4041',
        },
        {
          323: 'INANCEMENT   VIREMENT N 5295341',
          _1: '',
          _2: '040',
          _3: '0',
          '_4:': '000002',
          account_nb: '00410GXLT01',
          amount: '-34.93',
          bank_code: '18020',
          currency_code: 'EUR',
          desk_code: '00001',
          exempt_code: '',
          internal_code: '3126',
          label: 'TVA SUR PRECOMPTE DE COMM. DE F',
          nb_of_dec: '2',
          operation_code: '67',
          operation_date: '2023-03-06',
          record_code: '04',
          reference: '2059801',
          reject_code: '',
          value_date: '2023-03-04',
        },
        {
          323: 'NT   VIREMENT N 5295341',
          _1: '',
          _2: '040',
          _3: '0',
          '_4:': '000001',
          account_nb: '00410GXLT01',
          amount: '-174.63',
          bank_code: '18020',
          currency_code: 'EUR',
          desk_code: '00001',
          exempt_code: '',
          internal_code: '3026',
          label: 'PRECOMPTE DE COMM. DE FINANCEME',
          nb_of_dec: '2',
          operation_code: '61',
          operation_date: '2023-03-06',
          record_code: '04',
          reference: '2059801',
          reject_code: '',
          value_date: '2023-03-04',
        },
      ],
      problems: [
        {
          details: '"transactions[0].323" is not allowed',
          message: 'Malformed account',
        },
      ],
    });
  });

  test('Known bank 3 - no transactions', () => {
    const text = [
      `0118020    00001EUR2 00410GXLT01  210323                                                  0000000000000}`,
      `0718020    00001EUR2 00410GXLT01  220323                                                  0000000000000}`,
    ];

    expect(parse(text)).toEqual({
      amounts: {
        diff: 0,
        end: 0,
        start: 0,
        transactions: 0,
      },
      header: {
        record_code: '01',
        bank_code: '18020',
        desk_code: '00001',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '00410GXLT01',
        prev_date: '2023-03-21',
        prev_amount: '0',
        _1: '',
        _2: '',
        _3: '',
        _4: '',
        _5: '',
      },
      footer: {
        record_code: '07',
        bank_code: '18020',
        desk_code: '00001',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '00410GXLT01',
        next_date: '2023-03-22',
        next_amount: '0',
      },
      transactions: [],
      problems: null,
    });
  });

  test('Known bank 4 - no transactions', () => {
    const text = [
      `0118020    00001EUR2 00410GXLT11  210323                                                  0000019966371M`,
      `0718020    00001EUR2 00410GXLT11  220323                                                  0000019966371M                `,
    ];

    expect(parse(text)).toEqual({
      amounts: {
        diff: 0,
        end: -1996637.14,
        start: -1996637.14,
        transactions: 0,
      },
      header: {
        record_code: '01',
        bank_code: '18020',
        desk_code: '00001',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '00410GXLT11',
        prev_date: '2023-03-21',
        prev_amount: '-1996637.14',
        _1: '',
        _2: '',
        _3: '',
        _4: '',
        _5: '',
      },
      footer: {
        record_code: '07',
        bank_code: '18020',
        desk_code: '00001',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '00410GXLT11',
        next_date: '2023-03-22',
        next_amount: '-1996637.14',
      },
      transactions: [],
      problems: null,
    });
  });

  test('Sycomore 4', () => {
    const text = [
      `0130003    01678EUR2 00020086644  140423                                                  0000000472898C`,
      `0430003715001678EUR2 000200866447717042300170423CAT N  01678E2347600041          00000000 0000001800000{`,
      `0530003715001678EUR2 0002008664477170423     LIBECHU LE 17-04-2023`,
      `0430003715001678EUR2 000200866447717042300170423INTERETS CREDITEURS SUR CAT      00000000 0000000004280E`,
      `0530003715001678EUR2 0002008664477170423     LIBN 01678E2347600041`,
      `0530003715001678EUR2 0002008664477170423     LIBPERIODE DU 17/03/23 AU 17/04/23`,
      `0430003715001678EUR2 000200866447617042300170423OUVERTURE COMPTE A TERME N       00000001 0000001804280N`,
      `0530003715001678EUR2 0002008664476170423     LIB01678E2350700167 ECH 17-05-2023`,
      `0730003    01678EUR2 00020086644  170423                                                  0000000472898C`,
    ];

    expect(parse(text)).toEqual({
      amounts: {
        diff: 0,
        end: 47289.83,
        start: 47289.83,
        transactions: 0,
      },
      header: {
        record_code: '01',
        bank_code: '30003',
        desk_code: '01678',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '00020086644',
        prev_date: '2023-04-14',
        prev_amount: '47289.83',
        _1: '',
        _2: '',
        _3: '',
        _4: '',
        _5: '',
      },
      footer: {
        record_code: '07',
        bank_code: '30003',
        desk_code: '01678',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '00020086644',
        next_date: '2023-04-17',
        next_amount: '47289.83',
      },
      transactions: [
        {
          record_code: '04',
          bank_code: '30003',
          internal_code: '7150',
          desk_code: '01678',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: '',
          account_nb: '00020086644',
          operation_code: '77',
          operation_date: '2023-04-17',
          reject_code: '00',
          value_date: '2023-04-17',
          label: 'CAT N  01678E2347600041',
          _2: '',
          reference: '0000000',
          exempt_code: '0',
          _3: '',
          amount: '180000',
          '_4:': '',
          label_1: 'ECHU LE 17-04-2023',
        },
        {
          record_code: '04',
          bank_code: '30003',
          internal_code: '7150',
          desk_code: '01678',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: '',
          account_nb: '00020086644',
          operation_code: '77',
          operation_date: '2023-04-17',
          reject_code: '00',
          value_date: '2023-04-17',
          label: 'INTERETS CREDITEURS SUR CAT',
          _2: '',
          reference: '0000000',
          exempt_code: '0',
          _3: '',
          amount: '428.05',
          '_4:': '',
          label_1: 'N 01678E2347600041',
          label_2: 'PERIODE DU 17/03/23 AU 17/04/23',
        },
        {
          record_code: '04',
          bank_code: '30003',
          internal_code: '7150',
          desk_code: '01678',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: '',
          account_nb: '00020086644',
          operation_code: '76',
          operation_date: '2023-04-17',
          reject_code: '00',
          value_date: '2023-04-17',
          label: 'OUVERTURE COMPTE A TERME N',
          _2: '',
          reference: '0000000',
          exempt_code: '1',
          _3: '',
          amount: '-180428.05',
          '_4:': '',
          label_1: '01678E2350700167 ECH 17-05-2023',
        },
      ],
      problems: null,
    });
  });

  test('Sycomore 5', () => {
    const text = [
      `0130003    03300EUR2 00020547711  140423                                                  0000002209722A                `,
      `0430003740003300EUR2 000205477116217042300170423NTL RECU        360430885258     10485971 0000000000370}FRAIS VIR I     `,
      `0530003740003300EUR2 0002054771162170423     LIBREF 360430885258                                                        `,
      `0530003740003300EUR2 0002054771162170423     LIB  1 VIREMENT(S)          POUR  19 00                                    `,
      `0530003740003300EUR2 0002054771162170423     LIB  1 COMMISSION DE CHANGE POUR 18 00                                     `,
      `0430003432003300EUR2 00020547711B117042300170423PRELEVEMENT  METRO CASH CARRY F  50498840 0000000006041R1405049884      `,
      `0530003432003300EUR2 00020547711B1170423     NBEMETRO CASH CARRY FRANCE-METRO FRANCE`,
      `0530003432003300EUR2 00020547711B1170423     IBEFR17ZZZ452888`,
      `0530003432003300EUR2 00020547711B1170423     LCCPRELEVEMENT`,
      `0530003432003300EUR2 00020547711B1170423     RCN0109694881`,
      `0530003432003300EUR2 00020547711B1170423     RUMCMR000074241101`,
      `0730003    03300EUR2 00020547711  170423                                                  0000002203310B                C`,
    ];

    expect(parse(text)).toEqual({
      amounts: {
        diff: 641.19,
        end: 220331.02,
        start: 220972.21,
        transactions: 641.19,
      },
      header: {
        record_code: '01',
        bank_code: '30003',
        desk_code: '03300',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '00020547711',
        prev_date: '2023-04-14',
        prev_amount: '220972.21',
        _1: '',
        _2: '',
        _3: '',
        _4: '',
        _5: '',
      },
      footer: {
        record_code: '07',
        bank_code: '30003',
        desk_code: '03300',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '00020547711',
        next_date: '2023-04-17',
        next_amount: '220331.02',
      },
      transactions: [
        {
          record_code: '04',
          bank_code: '30003',
          internal_code: '7400',
          desk_code: '03300',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: '',
          account_nb: '00020547711',
          operation_code: '62',
          operation_date: '2023-04-17',
          reject_code: '00',
          value_date: '2023-04-17',
          label: 'NTL RECU        360430885258',
          _2: '',
          reference: '1048597',
          exempt_code: '1',
          _3: '',
          amount: '-37',
          '_4:': 'FRAIS VIR I',
          label_1: 'REF 360430885258',
          label_2: '1 VIREMENT(S)          POUR  19 00',
          label_3: '1 COMMISSION DE CHANGE POUR 18 00',
        },
        {
          record_code: '04',
          bank_code: '30003',
          internal_code: '4320',
          desk_code: '03300',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: '',
          account_nb: '00020547711',
          operation_code: 'B1',
          operation_date: '2023-04-17',
          reject_code: '00',
          value_date: '2023-04-17',
          label: 'PRELEVEMENT  METRO CASH CARRY F',
          _2: '',
          reference: '5049884',
          exempt_code: '0',
          _3: '',
          amount: '-604.19',
          '_4:': '1405049884',
          creditor_name: 'METRO CASH CARRY FRANCE-METRO FRANCE',
          creditor_id: 'FR17ZZZ452888',
          creditor_id_type: '',
          remittance_information_1: 'PRELEVEMENT',
          end2end_identification: '0109694881',
          purpose: '',
          mandate_identification: 'CMR000074241101',
          sequence_type: '',
        },
      ],
      problems: null,
    });
  });

  test('Sycomore 6', () => {
    const text = [
      '0130004    00071EUR2 00010139479  130423                                                  0000003327648G                ',
      '0430004008300071EUR2 0001013947928140423  140423DU 140423 INFOMANIAK.COM CARTE   00000000 0000000000945}4974XXXXXXXX0507',
      '0530004008300071EUR2 0001013947928140423     LIB CHE 94 50EUR                                                           ',
      '0430004081300071EUR2 00010139479B1140423  140423PRLV SEPA/FREE PRO                      0 0000000000959QFR16ZZZ521291   ',
      '0530004081300071EUR2 00010139479B1140423     NBEFREE PRO                                                                ',
      '0530004081300071EUR2 00010139479B1140423     IBEFR16ZZZ521291                                                           ',
      '0530004081300071EUR2 00010139479B1140423     LCCFACTURE FREEPRO 02/04/2023 F202304025208                                ',
      '0530004081300071EUR2 00010139479B1140423     RCN2652682                                                                 ',
      '0530004081300071EUR2 00010139479B1140423     RUMJNRUMVISAMUNDI000000020220916142704RCUR                                 ',
      '0430004008300071EUR2 0001013947928140423  140423DU 120423 BLS*MONDAY.COM1 CARTE  00000000 0000000001428} 4974XXXXXXXX050',
      '0530004008300071EUR2 0001013947928140423     LIB7 GBR 142 80EUR                                                         ',
      '0430004056300071EUR2 00010139479C2140423  140423MIRAMUNDI                        0000000  0000000003300{SCTINSTOUTU5KIEU',
      '0530004056300071EUR2 00010139479C2140423     NPYMIRAMUNDI                                                               ',
      '0530004056300071EUR2 00010139479C2140423     LCCF20220302-018                                                           ',
      '0530004056300071EUR2 00010139479C2140423     RCNSCTINSTOUTU5KIEUSARSWUR0X3HUXBG2                                        ',
      '0430004056300071EUR2 00010139479C2140423  140423MIRAMUNDI                        0000000  0000000018000{SCTINSTOUTD7PBAP',
      '0530004056300071EUR2 00010139479C2140423     NPYMIRAMUNDI                                                               ',
      '0530004056300071EUR2 00010139479C2140423     LCCTOP2022 / 3056617/1                                                     ',
      '0530004056300071EUR2 00010139479C2140423     RCNSCTINSTOUTD7PBAPXBEPJ2JRBUWPCNW9                                        ',
      '0430004056300071EUR2 00010139479C2140423  140423MIRAMUNDI                        0000000  0000000024000{SCTINSTOUTLMQOIT',
      '0530004056300071EUR2 00010139479C2140423     NPYMIRAMUNDI                                                               ',
      '0530004056300071EUR2 00010139479C2140423     LCC120502                                                                  ',
      '0530004056300071EUR2 00010139479C2140423     RCNSCTINSTOUTLMQOITIMXOBTMJD441PR81                                        ',
      '0430004056300071EUR2 00010139479C2140423  140423MIRAMUNDI                        0000000  0000000024600{SCTINSTOUTEWOGX0',
      '0530004056300071EUR2 00010139479C2140423     NPYMIRAMUNDI                                                               ',
      '0530004056300071EUR2 00010139479C2140423     LCC120602                                                                  ',
      '0530004056300071EUR2 00010139479C2140423     RCNSCTINSTOUTEWOGX0NUZGKKWAZFVNYIW9                                        ',
      '0730004    00071EUR2 00010139479  140423                                                  0000003676615I                ',
    ];

    expect(parse(text)).toEqual({
      amounts: {
        diff: 34896.72,
        end: 367661.59,
        start: 332764.87,
        transactions: 6656.72,
      },
      header: {
        record_code: '01',
        bank_code: '30004',
        _1: '',
        desk_code: '00071',
        currency_code: 'EUR',
        nb_of_dec: '2',
        _2: '',
        account_nb: '00010139479',
        _3: '',
        prev_date: '2023-04-13',
        _4: '',
        prev_amount: '332764.87',
        _5: '',
      },
      footer: {
        record_code: '07',
        bank_code: '30004',
        desk_code: '00071',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '00010139479',
        next_date: '2023-04-14',
        next_amount: '367661.59',
      },
      transactions: [
        {
          record_code: '04',
          bank_code: '30004',
          internal_code: '0083',
          desk_code: '00071',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: '',
          account_nb: '00010139479',
          operation_code: '28',
          operation_date: '2023-04-14',
          reject_code: '',
          value_date: '2023-04-14',
          label: 'DU 140423 INFOMANIAK.COM CARTE',
          _2: '',
          reference: '0000000',
          exempt_code: '0',
          _3: '',
          amount: '-94.5',
          '_4:': '4974XXXXXXXX0507',
          label_1: 'CHE 94 50EUR',
        },
        {
          record_code: '04',
          bank_code: '30004',
          internal_code: '0813',
          desk_code: '00071',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: '',
          account_nb: '00010139479',
          operation_code: 'B1',
          operation_date: '2023-04-14',
          reject_code: '',
          value_date: '2023-04-14',
          label: 'PRLV SEPA/FREE PRO',
          _2: '',
          reference: '',
          exempt_code: '0',
          _3: '',
          amount: '-95.98',
          '_4:': 'FR16ZZZ521291',
          creditor_name: 'FREE PRO',
          creditor_id: 'FR16ZZZ521291',
          creditor_id_type: '',
          remittance_information_1: 'FACTURE FREEPRO 02/04/2023 F202304025208',
          end2end_identification: '2652682',
          purpose: '',
          mandate_identification: 'JNRUMVISAMUNDI000000020220916142704',
          sequence_type: 'RCUR',
        },
        {
          record_code: '04',
          bank_code: '30004',
          internal_code: '0083',
          desk_code: '00071',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: '',
          account_nb: '00010139479',
          operation_code: '28',
          operation_date: '2023-04-14',
          reject_code: '',
          value_date: '2023-04-14',
          label: 'DU 120423 BLS*MONDAY.COM1 CARTE',
          _2: '',
          reference: '0000000',
          exempt_code: '0',
          _3: '',
          amount: '-142.8',
          '_4:': '4974XXXXXXXX050',
          label_1: '7 GBR 142 80EUR',
        },
        {
          record_code: '04',
          bank_code: '30004',
          internal_code: '0563',
          desk_code: '00071',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: '',
          account_nb: '00010139479',
          operation_code: 'C2',
          operation_date: '2023-04-14',
          reject_code: '',
          value_date: '2023-04-14',
          label: 'MIRAMUNDI',
          _2: '',
          reference: '0000000',
          exempt_code: '',
          _3: '',
          amount: '330',
          '_4:': 'SCTINSTOUTU5KIEU',
          debtor_name: 'MIRAMUNDI',
          remittance_information_1: 'F20220302-018',
          end2end_identification: 'SCTINSTOUTU5KIEUSARSWUR0X3HUXBG2',
          purpose: '',
        },
        {
          record_code: '04',
          bank_code: '30004',
          internal_code: '0563',
          desk_code: '00071',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: '',
          account_nb: '00010139479',
          operation_code: 'C2',
          operation_date: '2023-04-14',
          reject_code: '',
          value_date: '2023-04-14',
          label: 'MIRAMUNDI',
          _2: '',
          reference: '0000000',
          exempt_code: '',
          _3: '',
          amount: '1800',
          '_4:': 'SCTINSTOUTD7PBAP',
          debtor_name: 'MIRAMUNDI',
          remittance_information_1: 'TOP2022 / 3056617/1',
          end2end_identification: 'SCTINSTOUTD7PBAPXBEPJ2JRBUWPCNW9',
          purpose: '',
        },
        {
          record_code: '04',
          bank_code: '30004',
          internal_code: '0563',
          desk_code: '00071',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: '',
          account_nb: '00010139479',
          operation_code: 'C2',
          operation_date: '2023-04-14',
          reject_code: '',
          value_date: '2023-04-14',
          label: 'MIRAMUNDI',
          _2: '',
          reference: '0000000',
          exempt_code: '',
          _3: '',
          amount: '2400',
          '_4:': 'SCTINSTOUTLMQOIT',
          debtor_name: 'MIRAMUNDI',
          remittance_information_1: '120502',
          end2end_identification: 'SCTINSTOUTLMQOITIMXOBTMJD441PR81',
          purpose: '',
        },
        {
          record_code: '04',
          bank_code: '30004',
          internal_code: '0563',
          desk_code: '00071',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: '',
          account_nb: '00010139479',
          operation_code: 'C2',
          operation_date: '2023-04-14',
          reject_code: '',
          value_date: '2023-04-14',
          label: 'MIRAMUNDI',
          _2: '',
          reference: '0000000',
          exempt_code: '',
          _3: '',
          amount: '2460',
          '_4:': 'SCTINSTOUTEWOGX0',
          debtor_name: 'MIRAMUNDI',
          remittance_information_1: '120602',
          end2end_identification: 'SCTINSTOUTEWOGX0NUZGKKWAZFVNYIW9',
          purpose: '',
        },
      ],
      problems: [
        {
          message: 'Transaction #1 has problem(s)',
          line: '0430004008300071EUR2 0001013947928140423  140423DU 120423 BLS*MONDAY.COM1 CARTE  00000000 0000000001428} 4974XXXXXXXX050',
          details: ['transaction header missing part "reference"'],
        },
        {
          message:
            "Sum of transactions (6656.72) doesn't match with difference between start amount 332764.87 and end amount 367661.59",
        },
        {
          details: '"transactions[1].reference" is not allowed to be empty',
          message: 'Malformed account',
        },
      ],
    });
  });

  test('Sycomore 7 - transaction without body', () => {
    const text = [
      '0130004    00585EUR2 00010156142  130423                                                  0000008850455C                ',
      '0430004002900585EUR2 0001015614270140423  010423INTERETS ET COMMISSIONS          00000001 0000000004385N',
      '0730004    00585EUR2 00010156142  140423                                                  0000008846069H',
    ];

    expect(parse(text)).toEqual({
      amounts: {
        diff: 438.55,
        end: 884606.98,
        start: 885045.53,
        transactions: 438.55,
      },
      header: {
        record_code: '01',
        bank_code: '30004',
        desk_code: '00585',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '00010156142',
        prev_date: '2023-04-13',
        prev_amount: '885045.53',
        _1: '',
        _2: '',
        _3: '',
        _4: '',
        _5: '',
      },
      footer: {
        record_code: '07',
        bank_code: '30004',
        desk_code: '00585',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '00010156142',
        next_date: '2023-04-14',
        next_amount: '884606.98',
      },
      transactions: [
        {
          record_code: '04',
          bank_code: '30004',
          internal_code: '0029',
          desk_code: '00585',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: '',
          account_nb: '00010156142',
          operation_code: '70',
          operation_date: '2023-04-14',
          reject_code: '',
          value_date: '2023-04-01',
          label: 'INTERETS ET COMMISSIONS',
          _2: '',
          reference: '0000000',
          exempt_code: '1',
          _3: '',
          amount: '-438.55',
          '_4:': '',
        },
      ],
      problems: null,
    });
  });

  test('Sycomore 8 - transactions with some extra spaces in qualifier', () => {
    const text = [
      '0130004    00760EUR2 00010211516  130423                                                  0000003152474H                ',
      '0430004002900760EUR2 0001021151670140423  010423INTERETS ET COMMISSIONS          00000001 0000000002524Q                ',
      '0430004081300760EUR2 00010211516B1140423  140423PRLV SEPA/OVH SAS                       0 0000000000119QFR90ZZZ460983   ',
      '0530004081300760EUR2 00010211516B1140423     NBEOVH SAS                                                                 ',
      '0530004081300760EUR2 00010211516B1140423     IBEFR90ZZZ460983                                                           ',
      '0530004081300760EUR2 00010211516B1140423     LCCPAYMENT ORDER 188475917                                                 ',
      '0530004081300760EUR2 00010211516B1140423     RCNKP73765-OVH  ORDER 188475917                                            ',
      '0530004081300760EUR2 00010211516B1140423     RUMKP73765-OVH-FR-1                   RCUR                                 ',
      '0430004081300760EUR2 00010211516B1140423  140423PRLV SEPA/FREE PRO                      0 0000000000479RFR16ZZZ521291   ',
      '0530004081300760EUR2 00010211516B1140423     NBEFREE PRO                                                                ',
      '0530004081300760EUR2 00010211516B1140423     IBEFR16ZZZ521291                                                           ',
      '0530004081300760EUR2 00010211516B1140423     LCCFACTURE FREEPRO 02/04/2023 F202304007806                                ',
      '0530004081300760EUR2 00010211516B1140423     RCN2582434                                                                 ',
      '0530004081300760EUR2 00010211516B1140423     RUMJNRUMLAGRANDESERRE00020211007111533RCUR                                 ',
      '0430004081300760EUR2 00010211516B1140423  140423PRLV SEPA/LES JOYEUX RECYCLEURS         0 0000000000840}FR77ZZZ636205   ',
      '0530004081300760EUR2 00010211516B1140423     NBELES JOYEUX RECYCLEURS                                                   ',
      '0530004081300760EUR2 00010211516B1140423     IBEFR77ZZZ636205                                                           ',
      '0530004081300760EUR2 00010211516B1140423     LCCABONNEMENT 2023-04                                                      ',
      '0530004081300760EUR2 00010211516B1140423     RCNABONNEMENT 2023-04                                                      ',
      '0530004081300760EUR2 00010211516B1140423     RUMBOXDESJOYEUXRECYCLEURSC1091        RCUR                                 ',
      '0430004081300760EUR2 00010211516B1140423  140423PRLV SEPA/ORANGE SA-ORANGE              0 0000000000948}FR18ZZZ002305   ',
      '0530004081300760EUR2 00010211516B1140423     NBEORANGE SA-ORANGE                                                        ',
      '0530004081300760EUR2 00010211516B1140423     IBEFR18ZZZ002305                                                           ',
      '0530004081300760EUR2 00010211516B1140423     LCCVOTRE ABONNEMENT FIBRE (FACTURE  XXXXX3963C4) - P                       ',
      '0530004081300760EUR2 00010211516B1140423     RCN1B966E396 B966E3963C474E                                                ',
      '0530004081300760EUR2 00010211516B1140423     RUMM0062146555                        RCUR',
      '0730004    00760EUR2 00010211516  140423                                                  0000003233602C                ',
    ];

    expect(parse(text)).toEqual({
      amounts: {
        diff: 8112.75,
        end: 323360.23,
        start: 315247.48,
        transactions: 491.25,
      },
      header: {
        record_code: '01',
        bank_code: '30004',
        _1: '',
        desk_code: '00760',
        currency_code: 'EUR',
        nb_of_dec: '2',
        _2: '',
        account_nb: '00010211516',
        _3: '',
        prev_date: '2023-04-13',
        _4: '',
        prev_amount: '315247.48',
        _5: '',
      },
      footer: {
        record_code: '07',
        bank_code: '30004',
        desk_code: '00760',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '00010211516',
        next_date: '2023-04-14',
        next_amount: '323360.23',
      },
      transactions: [
        {
          record_code: '04',
          bank_code: '30004',
          internal_code: '0029',
          desk_code: '00760',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: '',
          account_nb: '00010211516',
          operation_code: '70',
          operation_date: '2023-04-14',
          reject_code: '',
          value_date: '2023-04-01',
          label: 'INTERETS ET COMMISSIONS',
          _2: '',
          reference: '0000000',
          exempt_code: '1',
          _3: '',
          amount: '-252.48',
          '_4:': '',
        },
        {
          record_code: '04',
          bank_code: '30004',
          internal_code: '0813',
          desk_code: '00760',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: '',
          account_nb: '00010211516',
          operation_code: 'B1',
          operation_date: '2023-04-14',
          reject_code: '',
          value_date: '2023-04-14',
          label: 'PRLV SEPA/OVH SAS',
          _2: '',
          reference: '',
          exempt_code: '0',
          _3: '',
          amount: '-11.98',
          '_4:': 'FR90ZZZ460983',
          creditor_name: 'OVH SAS',
          creditor_id: 'FR90ZZZ460983',
          creditor_id_type: '',
          remittance_information_1: 'PAYMENT ORDER 188475917',
          end2end_identification: 'KP73765-OVH  ORDER 188475917',
          purpose: '',
          mandate_identification: 'KP73765-OVH-FR-1                   ',
          sequence_type: 'RCUR',
        },
        {
          record_code: '04',
          bank_code: '30004',
          internal_code: '0813',
          desk_code: '00760',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: '',
          account_nb: '00010211516',
          operation_code: 'B1',
          operation_date: '2023-04-14',
          reject_code: '',
          value_date: '2023-04-14',
          label: 'PRLV SEPA/FREE PRO',
          _2: '',
          reference: '',
          exempt_code: '0',
          _3: '',
          amount: '-47.99',
          '_4:': 'FR16ZZZ521291',
          creditor_name: 'FREE PRO',
          creditor_id: 'FR16ZZZ521291',
          creditor_id_type: '',
          remittance_information_1: 'FACTURE FREEPRO 02/04/2023 F202304007806',
          end2end_identification: '2582434',
          purpose: '',
          mandate_identification: 'JNRUMLAGRANDESERRE00020211007111533',
          sequence_type: 'RCUR',
        },
        {
          record_code: '04',
          bank_code: '30004',
          internal_code: '0813',
          desk_code: '00760',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: '',
          account_nb: '00010211516',
          operation_code: 'B1',
          operation_date: '2023-04-14',
          reject_code: '',
          value_date: '2023-04-14',
          label: 'PRLV SEPA/LES JOYEUX RECYCLEURS',
          _2: '',
          reference: '',
          exempt_code: '0',
          _3: '',
          amount: '-84',
          '_4:': 'FR77ZZZ636205',
          creditor_name: 'LES JOYEUX RECYCLEURS',
          creditor_id: 'FR77ZZZ636205',
          creditor_id_type: '',
          remittance_information_1: 'ABONNEMENT 2023-04',
          end2end_identification: 'ABONNEMENT 2023-04',
          purpose: '',
          mandate_identification: 'BOXDESJOYEUXRECYCLEURSC1091        ',
          sequence_type: 'RCUR',
        },
        {
          record_code: '04',
          bank_code: '30004',
          internal_code: '0813',
          desk_code: '00760',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: '',
          account_nb: '00010211516',
          operation_code: 'B1',
          operation_date: '2023-04-14',
          reject_code: '',
          value_date: '2023-04-14',
          label: 'PRLV SEPA/ORANGE SA-ORANGE',
          _2: '',
          reference: '',
          exempt_code: '0',
          _3: '',
          amount: '-94.8',
          '_4:': 'FR18ZZZ002305',
          creditor_name: 'ORANGE SA-ORANGE',
          creditor_id: 'FR18ZZZ002305',
          creditor_id_type: '',
          remittance_information_1:
            'VOTRE ABONNEMENT FIBRE (FACTURE  XXXXX3963C4) - P',
          end2end_identification: '1B966E396 B966E3963C474E',
          purpose: '',
          mandate_identification: 'M0062146555                        ',
          sequence_type: 'RCUR',
        },
      ],
      problems: [
        {
          message: 'Transaction #1 has problem(s)',
          line: '0430004081300760EUR2 00010211516B1140423  140423PRLV SEPA/FREE PRO                      0 0000000000479RFR16ZZZ521291   ',
          details: ['transaction header missing part "reference"'],
        },
        {
          message: 'Transaction #2 has problem(s)',
          line: '0430004081300760EUR2 00010211516B1140423  140423PRLV SEPA/LES JOYEUX RECYCLEURS         0 0000000000840}FR77ZZZ636205   ',
          details: ['transaction header missing part "reference"'],
        },
        {
          message: 'Transaction #3 has problem(s)',
          line: '0430004081300760EUR2 00010211516B1140423  140423PRLV SEPA/ORANGE SA-ORANGE              0 0000000000948}FR18ZZZ002305   ',
          details: ['transaction header missing part "reference"'],
        },
        {
          message: 'Transaction #4 has problem(s)',
          line: '0730004    00760EUR2 00010211516  140423                                                  0000003233602C                ',
          details: ['transaction header missing part "reference"'],
        },
        {
          message:
            "Sum of transactions (491.25) doesn't match with difference between start amount 315247.48 and end amount 323360.23",
        },
        {
          details: '"transactions[1].reference" is not allowed to be empty',
          message: 'Malformed account',
        },
      ],
    });
  });

  test('Sobank', () => {
    const text = [
      '0110278    06186EUR2 00020828502  030323                                                  0000003522324E030323060323    ',
      '0410278930506186EUR2 0002082850218060323  060323VIR SARL TECOS                   0000000 00000000002520{                ',
      '0510278930506186EUR2 0002082850218060323     LIBREMB TROP PERCUE FACT SEPT                                              ',
      '0510278930506186EUR2 0002082850218060323     NOMSARL TECOS                         PROPULSE IT                          ',
      '0510278930506186EUR2 0002082850218060323     NBEPROPULSE IT                                                             ',
      '0510278930506186EUR2 0002082850218060323     NPYSARL TECOS                                                              ',
      '0510278930506186EUR2 0002082850218060323     LCCREMB TROP PERCUE FACT SEPT                                              ',
      '0510278930506186EUR2 0002082850218060323     RCNREMB TROP PERCUE FACT SEPT                                              ',
      '0510278930506186EUR2 0002082850218060323     REFREMBOUR                                                                 ',
      '0510278930506186EUR2 0002082850218060323     CBEFR7610278061860002082850258                                             ',
      '0710278    06186EUR2 00020828502  060323                                                  0000003524844E    ',
    ];

    expect(parse(text)).toEqual({
      amounts: {
        diff: 252,
        end: 352484.45,
        start: 352232.45,
        transactions: 252,
      },
      header: {
        record_code: '01',
        bank_code: '10278',
        desk_code: '06186',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '00020828502',
        prev_date: '2023-03-03',
        prev_amount: '352232.45',
        _1: '',
        _2: '',
        _3: '',
        _4: '',
        _5: '030323060323',
      },
      footer: {
        record_code: '07',
        bank_code: '10278',
        desk_code: '06186',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '00020828502',
        next_date: '2023-03-06',
        next_amount: '352484.45',
      },
      transactions: [
        {
          record_code: '04',
          bank_code: '10278',
          internal_code: '9305',
          desk_code: '06186',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: '',
          account_nb: '00020828502',
          operation_code: '18',
          operation_date: '2023-03-06',
          reject_code: '',
          value_date: '2023-03-06',
          label: 'VIR SARL TECOS',
          _2: '',
          reference: '0000000',
          exempt_code: '',
          _3: '0',
          amount: '252',
          '_4:': '',
          label_1: 'REMB TROP PERCUE FACT SEPT',
          NOM: 'SARL TECOS                         PROPULSE IT',
          creditor_name: 'PROPULSE IT',
          debtor_name: 'SARL TECOS',
          remittance_information_1: 'REMB TROP PERCUE FACT SEPT',
          end2end_identification: 'REMB TROP PERCUE FACT SEPT',
          purpose: '',
          payment_infor_id: 'REMBOUR',
          instruction_id: '',
          creditor_account: 'FR7610278061860002082850258',
        },
      ],
      problems: null,
    });
  });

  test('Sobank 1', () => {
    const text = [
      '0110207    00233EUR2 22216755392  060323                                                  0000000235185H                ',
      '0410207053700233EUR2E2221675539208070323  070323EUROPRELEVEMENT                  01P71OB100000000000561OAPPS COMMERCE   ',
      '0510207053700233EUR2E2221675539208070323     LIBAPPS COMMERCE PICKR.FR GG10340DH                                        ',
      '0510207053700233EUR2E2221675539208070323     LIB71626833                                                                ',
      '0510207053700233EUR2E2221675539208070323     LIBPRLV SEPA GOOGLE CLOUD F                                                ',
      '0710207    00233EUR2 22216755392  070323                                                  0000000234624B                ',
    ];

    expect(parse(text)).toEqual({
      amounts: {
        diff: 56.16,
        end: 23462.42,
        start: 23518.58,
        transactions: 56.16,
      },
      header: {
        record_code: '01',
        bank_code: '10207',
        desk_code: '00233',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '22216755392',
        prev_date: '2023-03-06',
        prev_amount: '23518.58',
        _1: '',
        _2: '',
        _3: '',
        _4: '',
        _5: '',
      },
      footer: {
        record_code: '07',
        bank_code: '10207',
        desk_code: '00233',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '22216755392',
        next_date: '2023-03-07',
        next_amount: '23462.42',
      },
      transactions: [
        {
          record_code: '04',
          bank_code: '10207',
          internal_code: '0537',
          desk_code: '00233',
          currency_code: 'EUR',
          nb_of_dec: '2',
          _1: 'E',
          account_nb: '22216755392',
          operation_code: '08',
          operation_date: '2023-03-07',
          reject_code: '',
          value_date: '2023-03-07',
          label: 'EUROPRELEVEMENT',
          _2: '',
          reference: '01P71OB',
          exempt_code: '1',
          _3: '0',
          amount: '-56.16',
          '_4:': 'APPS COMMERCE',
          label_1: 'APPS COMMERCE PICKR.FR GG10340DH',
          label_2: '71626833',
          label_3: 'PRLV SEPA GOOGLE CLOUD F',
        },
      ],
      problems: null,
    });
  });

  test('Sobank 2 - no transactions', () => {
    const text = [
      '0110207    00233EUR2 22216755392  030323                                                  0000000235185H                ',
      '0710207    00233EUR2 22216755392  060323                                                  0000000235185H        ',
    ];

    expect(parse(text)).toEqual({
      amounts: {
        diff: 0,
        end: 23518.58,
        start: 23518.58,
        transactions: 0,
      },
      header: {
        record_code: '01',
        bank_code: '10207',
        desk_code: '00233',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '22216755392',
        prev_date: '2023-03-03',
        prev_amount: '23518.58',
        _1: '',
        _2: '',
        _3: '',
        _4: '',
        _5: '',
      },
      footer: {
        record_code: '07',
        bank_code: '10207',
        desk_code: '00233',
        currency_code: 'EUR',
        nb_of_dec: '2',
        account_nb: '22216755392',
        next_date: '2023-03-06',
        next_amount: '23518.58',
      },
      transactions: [],
      problems: null,
    });
  });
});
